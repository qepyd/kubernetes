# 1.Etcd集群相关的证书
## 1.1 CA
```
## 相关证书(各Master Node上都有,内容是一样的)
/etc/kubernetes/pki/etcd/ca.crt
/etc/kubernetes/pki/etcd/ca.key

## 证书的Issuer
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/ca.crt -noout -issuer
issuer=CN = etcd-ca

## 证书的subject
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/ca.crt -noout -subject
subject=CN = etcd-ca
```

## 1.2 peer
```
## 相关证书(各Master Node上都有,内容不一样)
/etc/kubernetes/pki/etcd/peer.crt
/etc/kubernetes/pki/etcd/peer.key

## 类型
server、client

## 其颁发者(父CA)为etcd-ca(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/peer.crt -noout -issuer
issuer=CN = etcd-ca

## 验证是否是etcd集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/etcd/ca.crt   /etc/kubernetes/pki/etcd/peer.crt
/etc/kubernetes/pki/etcd/peer.crt: OK

## 其主体(subject)具备CN字段,它这里用于标识是给master01上的etcd节点所使用
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/peer.crt -noout -subject
subject=CN = master01

## 其主机(hosts)是需要指定的，因为有双向包含了server
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/peer.crt -noout -text | grep -A 1 "Subject Alternative Name:"
			X509v3 Subject Alternative Name: 
				DNS:localhost, DNS:master01, IP Address:172.31.7.201, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
```

## 1.3 server
```
## 相关证书(各Master Node上都有,内容不一样)
/etc/kubernetes/pki/etcd/server.crt
/etc/kubernetes/pki/etcd/server.key

## 类型
server

## 其颁发者(父CA)为etcd-ca(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -noout -issuer
issuer=CN = etcd-ca

## 验证是否是etcd集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/etcd/ca.crt   /etc/kubernetes/pki/etcd/server.crt
/etc/kubernetes/pki/etcd/server.crt: OK

## 主体(subject)只有CN字段,用于说明是给master01主机上其etcd节点所用。
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -noout -subject
subject=CN = master01

## 其主机(hosts)是需要指定的，因为它是server
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/server.crt -noout -text | grep -A 1 "Subject Alternative Name"
			X509v3 Subject Alternative Name: 
				DNS:localhost, DNS:master01, IP Address:172.31.7.201, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
```

## 1.4 healthcheck-client
```
## 相关证书(各Master Node上都有,内容不一样)
/etc/kubernetes/pki/etcd/healthcheck-client.crt
/etc/kubernetes/pki/etcd/healthcheck-client.key

## 类型
client

## 其颁发者(父CA)为etcd-ca(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/healthcheck-client.crt -noout -issuer
issuer=CN = etcd-ca

## 验证是否是etcd集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/etcd/ca.crt  /etc/kubernetes/pki/etcd/healthcheck-client.crt
/etc/kubernetes/pki/etcd/healthcheck-client.crt: OK

## 主体(subject)具备CN和O字段
root@master01:~# openssl x509 -in /etc/kubernetes/pki/etcd/healthcheck-client.crt -noout -subject
subject=O = system:masters, CN = kube-etcd-healthcheck-client

## 主机(hosts)不需要指定
因为其类型是client
```

## 1.5 apiserver-etcd-client
kube-apiserver组件各实例作为client去连接etcd集群时，需要用到的x509客户端证书。  
```
## 相关证书(各Master Node上都有,只不过内容不一样)
/etc/kubernetes/pki/apiserver-etcd-client.crt
/etc/kubernetes/pki/apiserver-etcd-client.key

## 类型
client

## 其颁发者(父CA)为etcd-ca(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver-etcd-client.crt -noout -issuer
issuer=CN = etcd-ca

## 验证是否是etcd集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/etcd/ca.crt   /etc/kubernetes/pki/apiserver-etcd-client.crt
/etc/kubernetes/pki/apiserver-etcd-client.crt: OK

## 主体(subject)具备CN和O字段
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver-etcd-client.crt -noout -subject
subject=O = system:masters, CN = kube-apiserver-etcd-client

## 主机(hosts)不需要指定
因为其类型是client
```






# 2.kubernetes集群的证书
## 2.1 CA
```
## 相关文件(各Master Node上都有,内容是一样的)
/etc/kubernetes/pki/ca.crt
/etc/kubernetes/pki/ca.key

## 证书的Issuer
root@master01:~# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -issuer
issuer=CN = kubernetes

## 证书的Subject
root@master01:~# openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -subject
subject=CN = kubernetes
```

## 2.2 apiserver-kubelet-client
kube-apiserver作为client去访问kubelet组件各实例时，其所用的x509客户端证书。  
```
## 相关证书(各Master Node上都有,内容不一样)
/etc/kubernetes/pki/apiserver-kubelet-client.crt
/etc/kubernetes/pki/apiserver-kubelet-client.key

## 类型
client

## 其颁发者(父CA)为kubernetes(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver-kubelet-client.crt -noout -issuer
issuer=CN = kubernetes

## 验证是否是k8s集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/ca.crt  /etc/kubernetes/pki/apiserver-kubelet-client.crt
/etc/kubernetes/pki/apiserver-kubelet-client.crt: OK

## 其主体(subject)具备O和CN字段
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver-kubelet-client.crt -noout -subject
subject=O = system:masters, CN = kube-apiserver-kubelet-client
  #
  # 不要暴露apiserver-kubelet-client的证书和私钥:
  # A:可通过kube-apiserver组件的身份验证之x509客户端证书
  # B:证书中的用户(CN)kube-apiserver-kubelet-client具备超级权限
  #    a:其加入的Group(system:masters)在k8s中是存在的
  #    b:clusterrolebinding/cluster-admin中承载了Group(system:masters),
  #      且绑定了clusterrole/cluster-admin具备管理k8s集群的超级权限
  # 

## 主机(hosts)不需要指定
因为其类型是client
```

## 2.3 apiserver
kube-apiserver作为服务端时的server证书
```
## 相关证书(各Master Node上都有，内容不一样)
/etc/kubernetes/pki/apiserver.crt
/etc/kubernetes/pki/apiserver.key

## 类型
server

## 其颁发者(父CA)为kubernetes(CA证书的issuer)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -issuer
issuer=CN = kubernetes

## 验证是否是k8s集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/ca.crt  /etc/kubernetes/pki/apiserver.crt
/etc/kubernetes/pki/apiserver.crt: OK

## 其主体(subject)具备CN字段(这个CN字段你可随便指定,例如:kbue-apiserver-server)
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -subject
subject=CN = kube-apiserver

## 主机(hosts)需要指定
root@master01:~# openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A 1 "Subject Alternative Name:" | tail -1 | tr "," "\n"
                DNS:k8s01-kubeapi-comp.qepyd.com      # 我部署k8s时人为指定的hosts,k8s中相关组件作为client去连接kube-apiserver时使用的地址
 DNS:kubernetes
 DNS:kubernetes.default
 DNS:kubernetes.default.svc
 DNS:kubernetes.default.svc.cluster.local             # k8s集群内部相关应用作为client去连接kube-apiserver时所使用的地址 
 DNS:master01
 IP Address:10.144.0.1
 IP Address:172.31.7.201
 IP Address:172.31.7.110                              # k8s集群外部client去连接kube-apiserver时所使用的地址,它是k8s external lb up vip
 IP Address:172.31.7.120                              # k8s集群外部client去连接kube-apiserver时所使用的地址,它是k8s external lb up vip
```


## 2.4 scheduler
kube-scheduler组件实例作为client去访问kube-apiserver时所用的x509客户端证书
```
## 相关证书(各Master Node上都有,内容不一样)
存在于/etc/kubernetes/scheduler.conf这个kubeconfig文件中
grep "client-certificate-data:" /etc/kubernetes/scheduler.conf | awk -F " " '{print $NF}'
grep "client-certificate-data:" /etc/kubernetes/scheduler.conf | awk -F " " '{print $NF}' | base64 -d  >/tmp/scheduler.crt

grep "client-key-data:" /etc/kubernetes/scheduler.conf | awk -F " " '{print $NF}'
grep "client-key-data:" /etc/kubernetes/scheduler.conf | awk -F " " '{print $NF}' | base64 -d  >/tmp/scheduler.key

## 类型
client

## 其颁发者(父CA)为kubernetes(CA证书的issuer)
root@master01:~# openssl x509 -in /tmp/scheduler.crt  -noout -issuer
issuer=CN = kubernetes

## 验证是否是k8s集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/ca.crt  /tmp/scheduler.crt
/tmp/scheduler.crt: OK

## 其主体(subject)具备CN字段(在kube-apiserver其访问控制的第二关之鉴权是有意义的)
root@master01:~# openssl x509 -in /tmp/scheduler.crt  -noout -subject
subject=CN = system:kube-scheduler
  #
  # CN表示用户名,这里没有加入任何的组(即没有任何的O字段).
  # k8s中其角色绑定中承载有：system:kube-scheduler这个用户
  #    ClusterRoleBinding/system:kube-scheduler
  #      #
  #      # subject为User，其name为system:kube-scheduler
  #      # 绑定了 ClusterRole/system:kube-scheduler 角色
  #      #
  #    ClusterRoleBinding/system:volume-scheduler
  #      #
  #      # subject为User，其name为system:kube-scheduler
  #      # 绑定了 ClusterRole/system:volume-scheduler 角色
  #      # 

## 主机(hosts)不需要指定
因为其类型是client
```


## 2.5 controller-manager
kube-controller-manager组件各实例作为client去访问kube-apiserver时所用的x509客户端证书
```
## 相关证书(各Master Node上都有,内容不一样)
存在于/etc/kubernetes/controller-manager.conf这个kubeconfig文件中
grep "client-certificate-data:" /etc/kubernetes/controller-manager.conf | awk -F " " '{print $NF}'
grep "client-certificate-data:" /etc/kubernetes/controller-manager.conf | awk -F " " '{print $NF}' | base64 -d  >/tmp/controller-manager.crt

grep "client-key-data:" /etc/kubernetes/controller-manager.conf | awk -F " " '{print $NF}'
grep "client-key-data:" /etc/kubernetes/controller-manager.conf | awk -F " " '{print $NF}' | base64 -d  >/tmp/controller-manager.key

## 类型
client

## 其颁发者(父CA)为kubernetes(CA证书的issuer)
root@master01:~# openssl x509 -in /tmp/controller-manager.crt -noout -issuer
issuer=CN = kubernetes

## 验证是否是k8s集群的CA签发
root@master01:~# openssl verify -CAfile /etc/kubernetes/pki/ca.crt   /tmp/controller-manager.crt
/tmp/controller-manager.crt: OK

## 其主体(subject)具备CN字段(在kube-apiserver其访问控制的第二关之鉴权是有意义的)
root@master01:~# openssl x509 -in /tmp/controller-manager.crt -noout -subject
subject=CN = system:kube-controller-manager
  #
  # CN表示用户名,这里没有加入任何的组(即没有任何的O字段).
  # k8s中其角色绑定中承载有 system:kube-controller-manager 这个用户
  #    ClusterRoleBinding/system:kube-controller-manager
  #      #
  #      # Subject为User，其name为system:kube-controller-manager
  #      # 绑定 ClusterRole/system:kube-controller-manager 角色
  #      # 
  #   

## 主机(hosts)不需要指定
因为其类型是client
```
